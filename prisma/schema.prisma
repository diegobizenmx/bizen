// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// SCHOOLS & LICENSING
// ========================================

model School {
  id           String   @id @default(cuid())
  name         String
  region       String?
  contactEmail String   @map("contact_email")
  createdAt    DateTime @default(now()) @map("created_at")

  licenses      License[]
  profiles      Profile[]
  schoolCourses SchoolCourse[]

  @@map("schools")
}

model License {
  id        String   @id @default(cuid())
  schoolId  String   @map("school_id")
  plan      String // "monthly" | "annual"
  seats     Int
  status    String // "active" | "expired" | "paused"
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("licenses")
}

// ========================================
// USERS & PROFILES
// ========================================

// Profile extends Supabase auth.users
model Profile {
  userId    String   @id @map("user_id") // FK to auth.users.id
  fullName  String   @map("full_name")
  role      String // "student" | "teacher" | "school_admin"
  schoolId  String?  @map("school_id")
  xp        Int      @default(0) // Experience points
  level     Int      @default(1) // Current level
  createdAt DateTime @default(now()) @map("created_at")

  school       School?       @relation(fields: [schoolId], references: [id])
  enrollments  Enrollment[]
  progress     Progress[]
  attempts     Attempt[]
  submissions  Submission[]
  certificates Certificate[]

  @@map("profiles")
}

// ========================================
// COURSES & CURRICULUM
// ========================================

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  level       String // "Beginner" | "Intermediate" | "Advanced"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  units         Unit[]
  enrollments   Enrollment[]
  certificates  Certificate[]
  schoolCourses SchoolCourse[]

  @@map("courses")
}

model SchoolCourse {
  schoolId  String  @map("school_id")
  courseId  String  @map("course_id")
  isEnabled Boolean @default(true) @map("is_enabled")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([schoolId, courseId])
  @@map("school_courses")
}

model Unit {
  id        String   @id @default(cuid())
  courseId  String   @map("course_id")
  title     String
  order     Int
  isLocked  Boolean  @default(false) @map("is_locked")
  createdAt DateTime @default(now()) @map("created_at")

  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons       Lesson[]
  assignments   Assignment[]
  prerequisites Prerequisite[] @relation("RequiresUnit")
  unlocks       Prerequisite[] @relation("UnlocksUnit")

  @@map("units")
}

model Lesson {
  id          String   @id @default(cuid())
  unitId      String   @map("unit_id")
  title       String
  contentType String   @map("content_type") // "video" | "reading" | "exercise"
  order       Int
  xpReward    Int      @default(50) @map("xp_reward") // XP awarded on completion
  createdAt   DateTime @default(now()) @map("created_at")

  unit             Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  quizzes          Quiz[]
  progress         Progress[]
  lessonObjectives LessonObjective[]

  @@map("lessons")
}

model Quiz {
  id          String   @id @default(cuid())
  lessonId    String   @map("lesson_id")
  title       String
  passScore   Int      @map("pass_score")
  totalPoints Int      @map("total_points")
  createdAt   DateTime @default(now()) @map("created_at")

  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  Attempt[]

  @@map("quizzes")
}

model Question {
  id     String @id @default(cuid())
  quizId String @map("quiz_id")
  type   String // "mcq" | "truefalse" | "short"
  prompt String
  order  Int

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[]

  @@map("questions")
}

model Option {
  id         String  @id @default(cuid())
  questionId String  @map("question_id")
  text       String
  isCorrect  Boolean @map("is_correct")

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("options")
}

model Objective {
  id          String  @id @default(cuid())
  title       String
  description String?
  level       String // "unit" | "lesson"

  lessonObjectives LessonObjective[]

  @@map("objectives")
}

model LessonObjective {
  lessonId    String @map("lesson_id")
  objectiveId String @map("objective_id")

  lesson    Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@id([lessonId, objectiveId])
  @@map("lesson_objectives")
}

model Prerequisite {
  id             String @id @default(cuid())
  unitId         String @map("unit_id") // unit to unlock
  requiresUnitId String @map("requires_unit_id") // prerequisite unit
  minScore       Int    @map("min_score") // e.g., 70

  unit         Unit @relation("UnlocksUnit", fields: [unitId], references: [id], onDelete: Cascade)
  requiresUnit Unit @relation("RequiresUnit", fields: [requiresUnitId], references: [id], onDelete: Cascade)

  @@map("prerequisites")
}

model Assignment {
  id        String    @id @default(cuid())
  unitId    String    @map("unit_id")
  title     String
  type      String // "file" | "link" | "text"
  dueAt     DateTime? @map("due_at")
  points    Int
  createdAt DateTime  @default(now()) @map("created_at")

  unit        Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@map("assignments")
}

model Submission {
  id           String   @id @default(cuid())
  assignmentId String   @map("assignment_id")
  userId       String   @map("user_id")
  url          String? // or text content
  status       String // "submitted" | "graded"
  score        Int?
  submittedAt  DateTime @default(now()) @map("submitted_at")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       Profile    @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("submissions")
}

// ========================================
// STUDENT PROGRESS
// ========================================

model Enrollment {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  courseId   String   @map("course_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at")

  user   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Progress {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  lessonId    String    @map("lesson_id")
  percent     Int       @default(0)
  completedAt DateTime? @map("completed_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  user   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  lesson Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("progress")
}

model Attempt {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  quizId      String   @map("quiz_id")
  score       Int
  completedAt DateTime @default(now()) @map("completed_at")

  user Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  quiz Quiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("attempts")
}

model Certificate {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  courseId String   @map("course_id")
  url      String?
  issuedAt DateTime @default(now()) @map("issued_at")

  user   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("certificates")
}
