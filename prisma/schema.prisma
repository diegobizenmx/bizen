// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User section completion tracking
model UserSectionCompletion {
  userId      String   @map("user_id")
  moduleId    Int      @map("module_id")
  sectionNumber Int    @map("section_number")
  createdAt   DateTime? @map("created_at") @default(now())
  
  @@id([userId, moduleId, sectionNumber])
  @@map("user_section_completion")
}

// User module progress tracking
model UserModuleProgress {
  userId         String   @map("user_id")
  moduleId       Int      @map("module_id")
  unlockedSection Int     @map("unlocked_section") @default(1)
  completed      Boolean  @default(false)
  updatedAt      DateTime @map("updated_at") @default(now()) @updatedAt
  
  @@id([userId, moduleId])
  @@map("user_module_progress")
}

// Progress tracking (referenced in dashboard)
model Progress {
  userId      String   @map("user_id")
  sectionId   String   @map("section_id")
  status      String
  percent     Int
  completedAt DateTime? @map("completed_at")
  
  @@id([userId, sectionId], name: "userId_sectionId")
  @@map("progress")
}

// File uploads for Module 6
model FileUpload {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  userName    String?  @map("user_name")
  userEmail   String?  @map("user_email")
  originalName String  @map("original_name")
  filename    String
  title       String?
  notes       String?
  size        Int
  type        String
  path        String
  uploadedAt  DateTime @map("uploaded_at") @default(now())
  
  @@map("file_uploads")
}

// Course information
model Course {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  level       String
  duration    String
  image       String?
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  modules     Module[]
  
  @@map("courses")
}

// Module information
model Module {
  id          Int      @id @default(autoincrement())
  courseId    Int      @map("course_id")
  title       String
  description String?
  gradeLevel  Int      @map("grade_level")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sections    Section[]
  
  @@map("modules")
}

// Section information
model Section {
  id          Int      @id @default(autoincrement())
  moduleId    Int      @map("module_id")
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@map("sections")
}

// Page visit tracking - tracks every page a user views
model PageVisit {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  moduleId    Int      @map("module_id")
  sectionId   Int      @map("section_id")
  pageNumber  Int      @map("page_number")
  visitedAt   DateTime @default(now()) @map("visited_at")
  
  @@index([userId, moduleId, sectionId])
  @@map("page_visits")
}

// Quiz attempt tracking - stores every quiz attempt (no retakes allowed)
model QuizAttempt {
  id            Int      @id @default(autoincrement())
  userId        String   @map("user_id")
  moduleId      Int      @map("module_id")
  sectionId     Int      @map("section_id")
  pageNumber    Int      @map("page_number")
  quizType      String   @map("quiz_type") // 'true_false', 'multiple_choice'
  score         Int      // number of correct answers
  totalQuestions Int     @map("total_questions")
  completedAt   DateTime @default(now()) @map("completed_at")
  
  // Relations
  answers       QuizAnswer[]
  
  @@unique([userId, moduleId, sectionId, pageNumber])
  @@index([userId])
  @@map("quiz_attempts")
}

// Individual quiz answers - stores each answer
model QuizAnswer {
  id              Int      @id @default(autoincrement())
  quizAttemptId   Int      @map("quiz_attempt_id")
  questionIndex   Int      @map("question_index") // 0-based index
  questionText    String   @map("question_text")
  userAnswer      String   @map("user_answer") // JSON string of answer
  correctAnswer   String   @map("correct_answer") // JSON string of correct answer
  isCorrect       Boolean  @map("is_correct")
  answeredAt      DateTime @default(now()) @map("answered_at")
  
  // Relations
  quizAttempt     QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  
  @@index([quizAttemptId])
  @@map("quiz_answers")
}

// Section completion - tracks when all pages and quizzes in a section are done
model SectionCompletion {
  userId        String   @map("user_id")
  moduleId      Int      @map("module_id")
  sectionId     Int      @map("section_id")
  totalPages    Int      @map("total_pages")
  pagesVisited  Int      @map("pages_visited")
  quizzesTotal  Int      @map("quizzes_total")
  quizzesCompleted Int   @map("quizzes_completed")
  isComplete    Boolean  @default(false) @map("is_complete")
  completedAt   DateTime? @map("completed_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  
  @@id([userId, moduleId, sectionId])
  @@index([userId])
  @@map("section_completions")
}

// Diagnostic quiz - one-time assessment before accessing modules
model DiagnosticQuiz {
  id              Int      @id @default(autoincrement())
  userId          String   @unique @map("user_id")
  score           Int      // number of correct answers
  totalQuestions  Int      @map("total_questions")
  scorePct        Int      @map("score_pct") // percentage score
  studentName     String?  @map("student_name")
  evaluatorNotes  String?  @map("evaluator_notes")
  answersData     String   @map("answers_data") // JSON string of all answers
  completedAt     DateTime @default(now()) @map("completed_at")
  
  @@index([userId])
  @@map("diagnostic_quiz")
}
